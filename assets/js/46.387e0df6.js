(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{453:function(t,s,n){"use strict";n.r(s);var a=n(34),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"二-基本操作"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二-基本操作"}},[t._v("#")]),t._v(" 二. 基本操作")]),t._v(" "),n("h2",{attrs:{id:"_1-ros与无法进行ros连接的软件通信"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-ros与无法进行ros连接的软件通信"}},[t._v("#")]),t._v(" 1. ros与无法进行ros连接的软件通信")]),t._v(" "),n("p",[t._v("将websocts的发送函数作为ros订阅的回调。")]),t._v(" "),n("p",[t._v("例如，ros在与打包成webgl的unity模型进行通信时，可以将发送消息的函数放入订阅消息的回调函数之中。")]),t._v(" "),n("div",{staticClass:"language-shell extra-class"},[n("pre",{pre:!0,attrs:{class:"language-shell"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/usr/bin/env python")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" threading\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" rospy\nfrom std_msgs.msg "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" String\n\n"),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" tornado\nfrom tornado "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("import")]),t._v(" websocket\n\nwrite_func "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" None\nport "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[t._v("7070")]),t._v("\n\nclass EchoWebSocket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("websocket.WebSocketHandler"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n    def open"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n        global write_func\n        write_func "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" self.write_message\n        rospy.loginfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"New client connected"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        \n    def on_message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self, message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n        pass\n    \n    def on_close"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n        global write_func\n        write_func "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" None\n        self.loop.stop"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        rospy.loginfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Connection is closed"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    def check_origin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("self, origin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n        "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("return")]),t._v(" True\n\ndef callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# rospy.loginfo("Sub data: %s", str(data.data))')]),t._v("\n\n    global write_func\n    "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" write_func:\n        "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# write_func(data.data, binary=True)")]),t._v("\n        write_func"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data.data.decode"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'hex'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(", "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("binary")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("True"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        rospy.loginfo"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ws2unity data: %s"')]),t._v(", str"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("data.data"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("))")]),t._v("\n        \n\n    \ndef ros_listener"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# In ROS, nodes are uniquely named. If two nodes with the same")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# name are launched, the previous one is kicked off. The")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# anonymous=True flag means that rospy will choose a unique")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# name for our 'listener' node so that multiple listeners can")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# run simultaneously.")]),t._v("\n    rospy.init_node"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'model_ctl_server'")]),t._v(", "),n("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("anonymous")]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("True"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    rospy.Subscriber"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/crane_cmd/hex_cmd"')]),t._v(", String, callback"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    ros_thread "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" threading.Thread"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ros_spin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ros_thread.start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n\ndef ros_spin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# spin() simply keeps python from exiting until this node is stopped")]),t._v("\n    rospy.spin"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\ndef ws_server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(":\n    global port\n    app "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" tornado.web.Application"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("r"),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),t._v(", EchoWebSocket"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    app.listen"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("port"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    tornado.ioloop.IOLoop.current"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" __name__ "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'__main__'")]),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v("\n    ros_listener"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    \n    ws_thread "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" threading.Thread"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("target "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ws_server"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ws_thread.start"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n")])])]),n("p",[t._v("其中的"),n("code",[t._v("write_func")]),t._v("即为发送消息函数的全局变量。")])])}),[],!1,null,null,null);s.default=e.exports}}]);