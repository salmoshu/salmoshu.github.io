<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一. 基本使用 | Salmos&#39; blog</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/doghead.jpg">
    <meta name="description" content="Recording ideas">
    
    <link rel="preload" href="/assets/css/0.styles.b4c82722.css" as="style"><link rel="preload" href="/assets/js/app.f9092013.js" as="script"><link rel="preload" href="/assets/js/2.b3dd7b33.js" as="script"><link rel="preload" href="/assets/js/14.b2278c23.js" as="script"><link rel="prefetch" href="/assets/js/10.6c64a4b4.js"><link rel="prefetch" href="/assets/js/11.b6b65285.js"><link rel="prefetch" href="/assets/js/12.6e402835.js"><link rel="prefetch" href="/assets/js/13.2c2d1f34.js"><link rel="prefetch" href="/assets/js/15.453df6ec.js"><link rel="prefetch" href="/assets/js/16.551ba86a.js"><link rel="prefetch" href="/assets/js/17.b8f0b5bc.js"><link rel="prefetch" href="/assets/js/18.8127ce1b.js"><link rel="prefetch" href="/assets/js/19.a3ff3929.js"><link rel="prefetch" href="/assets/js/20.a95543b1.js"><link rel="prefetch" href="/assets/js/21.b3e848da.js"><link rel="prefetch" href="/assets/js/22.b1b35e21.js"><link rel="prefetch" href="/assets/js/23.04dd7eaf.js"><link rel="prefetch" href="/assets/js/24.14feb4e6.js"><link rel="prefetch" href="/assets/js/25.899c76cd.js"><link rel="prefetch" href="/assets/js/26.f3a4237f.js"><link rel="prefetch" href="/assets/js/27.32de43db.js"><link rel="prefetch" href="/assets/js/28.0ed94adc.js"><link rel="prefetch" href="/assets/js/29.045c20f6.js"><link rel="prefetch" href="/assets/js/3.4f314f2c.js"><link rel="prefetch" href="/assets/js/30.5f54ef66.js"><link rel="prefetch" href="/assets/js/31.19c0e997.js"><link rel="prefetch" href="/assets/js/32.3fd4bf1d.js"><link rel="prefetch" href="/assets/js/33.83786157.js"><link rel="prefetch" href="/assets/js/34.7b0bd806.js"><link rel="prefetch" href="/assets/js/35.b4e9e0aa.js"><link rel="prefetch" href="/assets/js/36.a74444e5.js"><link rel="prefetch" href="/assets/js/37.2ea7b216.js"><link rel="prefetch" href="/assets/js/38.0698ffec.js"><link rel="prefetch" href="/assets/js/39.acd1cc16.js"><link rel="prefetch" href="/assets/js/4.b8383393.js"><link rel="prefetch" href="/assets/js/5.c9252961.js"><link rel="prefetch" href="/assets/js/6.d9e06979.js"><link rel="prefetch" href="/assets/js/7.bfd202d2.js"><link rel="prefetch" href="/assets/js/8.97616267.js"><link rel="prefetch" href="/assets/js/9.7e493ad0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4c82722.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/doghead.jpg" alt="Salmos' blog" class="logo"> <span class="site-name can-hide">Salmos' blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/control/" class="nav-link">
  Control Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/B/" class="nav-link">
  算法B
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="平台与软件" class="dropdown-title"><span class="title">平台与软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="平台与软件" class="mobile-dropdown-title"><span class="title">平台与软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          嵌入式开发板
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/nano/" class="nav-link">
  Jetson Nano
</a></li></ul></li><li class="dropdown-item"><h4>
          操作系统与软件平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-subitem"><a href="/platform/ros1/" class="nav-link">
  ROS1
</a></li><li class="dropdown-subitem"><a href="/platform/ros2/" class="nav-link">
  ROS2
</a></li></ul></li><li class="dropdown-item"><h4>
          仿真平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/simulation/physics/" class="nav-link">
  physics
</a></li><li class="dropdown-subitem"><a href="/platform/simulation/gazebo/" class="nav-link">
  gazebo
</a></li><li class="dropdown-subitem"><a href="/platform/simulation/unity/" class="nav-link">
  unity
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GUI" class="dropdown-title"><span class="title">GUI</span> <span class="arrow down"></span></button> <button type="button" aria-label="GUI" class="mobile-dropdown-title"><span class="title">GUI</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Web
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gui/web/vuepress/" class="nav-link">
  VuePress
</a></li><li class="dropdown-subitem"><a href="/gui/web/layui/" class="nav-link">
  Layui
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          webapp
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/webapp/tornado/" class="nav-link router-link-active">
  tornado
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tools/git/" class="nav-link">
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Pieces" class="dropdown-title"><span class="title">Pieces</span> <span class="arrow down"></span></button> <button type="button" aria-label="Pieces" class="mobile-dropdown-title"><span class="title">Pieces</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pieces/p1/" class="nav-link">
  p1
</a></li><li class="dropdown-item"><!----> <a href="/pieces/p2/" class="nav-link">
  p2
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="算法" class="dropdown-title"><span class="title">算法</span> <span class="arrow down"></span></button> <button type="button" aria-label="算法" class="mobile-dropdown-title"><span class="title">算法</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/algorithm/control/" class="nav-link">
  Control Algorithm
</a></li><li class="dropdown-item"><!----> <a href="/algorithm/B/" class="nav-link">
  算法B
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="平台与软件" class="dropdown-title"><span class="title">平台与软件</span> <span class="arrow down"></span></button> <button type="button" aria-label="平台与软件" class="mobile-dropdown-title"><span class="title">平台与软件</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          嵌入式开发板
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/nano/" class="nav-link">
  Jetson Nano
</a></li></ul></li><li class="dropdown-item"><h4>
          操作系统与软件平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/linux/" class="nav-link">
  linux
</a></li><li class="dropdown-subitem"><a href="/platform/ros1/" class="nav-link">
  ROS1
</a></li><li class="dropdown-subitem"><a href="/platform/ros2/" class="nav-link">
  ROS2
</a></li></ul></li><li class="dropdown-item"><h4>
          仿真平台
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/platform/simulation/physics/" class="nav-link">
  physics
</a></li><li class="dropdown-subitem"><a href="/platform/simulation/gazebo/" class="nav-link">
  gazebo
</a></li><li class="dropdown-subitem"><a href="/platform/simulation/unity/" class="nav-link">
  unity
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GUI" class="dropdown-title"><span class="title">GUI</span> <span class="arrow down"></span></button> <button type="button" aria-label="GUI" class="mobile-dropdown-title"><span class="title">GUI</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Web
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/gui/web/vuepress/" class="nav-link">
  VuePress
</a></li><li class="dropdown-subitem"><a href="/gui/web/layui/" class="nav-link">
  Layui
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          webapp
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/backend/webapp/tornado/" class="nav-link router-link-active">
  tornado
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具" class="dropdown-title"><span class="title">工具</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具" class="mobile-dropdown-title"><span class="title">工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/vscode/" class="nav-link">
  vscode
</a></li><li class="dropdown-item"><!----> <a href="/tools/git/" class="nav-link">
  git
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Pieces" class="dropdown-title"><span class="title">Pieces</span> <span class="arrow down"></span></button> <button type="button" aria-label="Pieces" class="mobile-dropdown-title"><span class="title">Pieces</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pieces/p1/" class="nav-link">
  p1
</a></li><li class="dropdown-item"><!----> <a href="/pieces/p2/" class="nav-link">
  p2
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/backend/webapp/tornado/" aria-current="page" class="sidebar-link">tornado</a></li><li><a href="/backend/webapp/tornado/01_tutorials.html" aria-current="page" class="active sidebar-link">一. 基本使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/webapp/tornado/01_tutorials.html#_1-tornado实现多线程、多进程http服务方案" class="sidebar-link">1. tornado实现多线程、多进程HTTP服务方案</a></li><li class="sidebar-sub-header"><a href="/backend/webapp/tornado/01_tutorials.html#_1" class="sidebar-link">1.</a></li></ul></li><li><a href="/backend/webapp/tornado/02_issues.html" class="sidebar-link">二. issues</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/backend/webapp/tornado/02_issues.html#_1" class="sidebar-link">1.</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一-基本使用"><a href="#一-基本使用" class="header-anchor">#</a> 一. 基本使用</h1> <p>主要参考：
https://tornado-zh.readthedocs.io</p> <h2 id="_1-tornado实现多线程、多进程http服务方案"><a href="#_1-tornado实现多线程、多进程http服务方案" class="header-anchor">#</a> 1. tornado实现多线程、多进程HTTP服务方案</h2> <h4 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接：</h4> <p>https://blog.csdn.net/weixin_36245388/article/details/111967886<br>
说明：该部分内容转载自上述链接，作者金知。</p> <h4 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h4> <p>线上有一个相关百科的服务，返回一个query中提及的百科词条。该服务是用python实现的，以前通过thrift接口访问，现要将其改为通过HTTP访问。之前没有搭建HTTPServer的经验，因此想用python的web Framework来做这件事，于是有了下面的工作。</p> <p>第一部分是框架选择，这一部分没有太仔细考虑，只是大概看了一些文章；第二部分是根据所需要的功能，学习及测试在框架上应该如何实现；第三部分是实际的代码；第四部分是下一步的学习。</p> <h4 id="框架选择"><a href="#框架选择" class="header-anchor">#</a> 框架选择</h4> <p>python有很多开源的web framework。从知乎上找了几篇综述型的简介，大体包括：Django、Bottle、Flask、web2py、Tornado。看中了介绍中提及Tornado的速度与并发量，于是打算用tornado来实现。所以按目前的了解，或许Tornado并非实现本工作的最佳方案，只是一个可行方案。</p> <h4 id="学习与测试"><a href="#学习与测试" class="header-anchor">#</a> 学习与测试</h4> <p>用tornado开发web服务的基本流程</p> <p>tornado具有web framework的功能，因此用它开发web服务非常方便：</p> <p>实现处理请求的Handler，该类继承自tornado.web.RequestHandler，实现用于处理请求的对应方法如：get、post等。返回内容用self.write方法输出。</p> <p>实例化一个Application。构造函数的参数是一个Handlers列表，通过正则表达式，将请求与Handler对应起来。通过dict将Handler需要的其他对象以参数的方式传递给Handler的initialize方法。</p> <p>初始化一个tornado.httpserver.HTTPServer对象，构造函数的参数是上一步的Application对象。</p> <p>为HTTPServer对象绑定一个端口。</p> <p>开始IOLoop。</p> <h4 id="原服务的特点"><a href="#原服务的特点" class="header-anchor">#</a> 原服务的特点</h4> <p>原服务是一个内存占用大，IO密集，计算量适中的服务。</p> <p>内存占用大。需要加载一个比较大的词表，其中每个词对应一个id列表，这一部分是C++实现的，通过boost.python封装为python可调用的so。原服务单进程占用内存超过5G。</p> <p>IO密集。计算过程中大量访问redis读取term及baikeid的属性信息，用于过滤及rank计算。也访问在线分词服务，获取各term的NLP分析。</p> <p>计算量适中。划词匹配、rank计算有一定计算量，但是总体来看计算量不是特别大。python单进程每天500多万的访问量，单CPU利用率也就40%-50%之间。</p> <h4 id="关于服务的分析"><a href="#关于服务的分析" class="header-anchor">#</a> 关于服务的分析：</h4> <p>内存占用大。内存占用大，但绝大部分是只读的。不适合独立启动多个进程，适合多线程或用子进程。</p> <p>IO密集。适合将IO操作都变为异步请求，或者用多线程模型。</p> <p>计算量适中。由于python解释器使用GIL，多线程只能提高IO的并发能力，不能提高计算的并发能力。因此可以考虑通过子进程的方式，适当增加提供服务的进程数，提高整个系统服务能力的上限。</p> <h4 id="需要用到的特性"><a href="#需要用到的特性" class="header-anchor">#</a> 需要用到的特性</h4> <p>由于tornado的亮点是异步请求，所以这里首先想到的是将所有请求都改造为异步的。但是这里遇到一个问题，就是异步函数内一定不能有阻塞调用出现，否则整个IOLoop都会被卡住。这就要求彻底地去改造服务，将所有IO或是用时较长的请求都改造为异步函数。这个工程量是非常大的，需要去修改已有的代码。因此，我们考虑用线程池的方式去实现。当一个线程阻塞在某个请求或IO时，其他线程或IOLoop会继续执行。</p> <p>另外一个瓶颈就是GIL限制了CPU的并发数量，因此考虑用子进程的方式增加进程数，提高服务能力上限。</p> <p>综合上面的分析，大致用以下方案：</p> <p>通过子进程的方式复制多个进程，使子进程中的只读页指向同一个物理页。</p> <p>线程池。回避异步改造的工作量，增加IO的并发量。</p> <h4 id="测试代码"><a href="#测试代码" class="header-anchor">#</a> 测试代码</h4> <p>首先测试线程池，测试用例为：</p> <p>对sleep页面同时发出两个请求：</p> <p>在线程池中运行的函数(这里是self.block_task)能够同时执行。表现为在控制台交替打印出数字。</p> <p>两个get请求几乎同时返回，在浏览器上显示返回的内容。</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> time
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>httpserver
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>ioloop
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>options
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>web
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>gen
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>concurrent <span class="token keyword">import</span> run_on_executor
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>options <span class="token keyword">import</span> define<span class="token punctuation">,</span> options

<span class="token keyword">class</span> <span class="token class-name">HasBlockTaskHandler</span><span class="token punctuation">(</span>tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token comment">#起线程池，由当前RequestHandler持有</span>

    <span class="token decorator annotation punctuation">@tornado<span class="token punctuation">.</span>gen<span class="token punctuation">.</span>coroutine</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        strTime <span class="token operator">=</span> time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">&quot;%Y-%m-%d %H:%M:%S&quot;</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">&quot;in get before block_task %s&quot;</span> <span class="token operator">%</span> strTime
        result <span class="token operator">=</span> <span class="token keyword">yield</span> self<span class="token punctuation">.</span>block_task<span class="token punctuation">(</span>strTime<span class="token punctuation">)</span>
        <span class="token keyword">print</span> <span class="token string">&quot;in get after block_task&quot;</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">&quot;%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@run_on_executor</span>
    <span class="token keyword">def</span> <span class="token function">block_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> strTime<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span> <span class="token string">&quot;in block_task %s&quot;</span> <span class="token operator">%</span> strTime
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span> <span class="token string">&quot;step %d : %s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> strTime<span class="token punctuation">)</span>

        <span class="token keyword">return</span> <span class="token string">&quot;Finish %s&quot;</span> <span class="token operator">%</span> strTime

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>

    tornado<span class="token punctuation">.</span>options<span class="token punctuation">.</span>parse_command_line<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>handlers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">r&quot;/sleep&quot;</span><span class="token punctuation">,</span> HasBlockTaskHandler<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> autoreload<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    http_server <span class="token operator">=</span> tornado<span class="token punctuation">.</span>httpserver<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
    tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>整个代码里有几个位置值得关注：</p> <p>executor = ThreadPoolExecutor(20)。这是给Handler类初始化了一个线程池。其中concurrent.futures不属于tornado，是python的一个独立模块，在python3中是内置模块，python2.7需要自己安装。</p> <p>修饰符@run_on_executor。这个修饰符将同步函数改造为在executor(这里是线程池)上运行的异步函数，内部实现是将被修饰的函数submit到executor，返回一个Future对象。</p> <p>修饰符@tornado.gen.coroutine。被这个修饰符修饰的函数，是一个以同步函数方式编写的异步函数。原本通过callback方式编写的异步代码，有了这个修饰符，可以通过yield一个Future的方式来写。被修饰的函数在yield了一个Future对象后将会被挂起，Future对象的结果返回后继续执行。</p> <p>运行代码后，在两个不同浏览器上访问sleep页面，得到了想要的效果。这里有一个小插曲，就是如果在同一浏览器的两个tab上进行测试，是无法看到想要的效果。第二个get请求会被block，直到第一个get请求返回，服务端才开始处理第二个get请求。这让我一度觉得多线程没有生效，用了半天时间查了很多资料，才看到是浏览器把相同的第二个请求block了，具体链接参考这里。</p> <p>由于tornado很方便地支持多进程模型，多进程的使用要简单很多，在以上例子中，只需要对启动部分稍作改动即可。具体代码如下所示：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    tornado<span class="token punctuation">.</span>options<span class="token punctuation">.</span>parse_command_line<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app <span class="token operator">=</span> tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>handlers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">r&quot;/sleep&quot;</span><span class="token punctuation">,</span> HasBlockTaskHandler<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> autoreload<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> debug<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    http_server <span class="token operator">=</span> tornado<span class="token punctuation">.</span>httpserver<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span> tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>initialized<span class="token punctuation">(</span><span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
    tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>需要注意的地方有两点：</p> <p>app = tornado.web.Application(handlers=[(r&quot;/sleep&quot;, HasBlockTaskHandler)], autoreload=False, debug=False)，在生成Application对象时，要将autoreload和debug两个参数至为False。也就是需要保证在fork子进程之前IOLoop是未被初始化的。这个可以通过tornado.ioloop.IOLoop.initialized()函数来跟。</p> <p>http_server.start(5)在启动IOLoop之前通过start函数设置进程数量，如果设置为0表示每个CPU都启动一个进程。</p> <p>最后的效果是可以看到n+1个进程在运行，且公用同一个端口。</p> <p>实际代码</p> <p>大部分逻辑代码是封装好的，服务的代码如下：</p> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">import</span> json
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>httpserver
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>ioloop
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>options
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>httpclient
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>web
<span class="token keyword">import</span> tornado<span class="token punctuation">.</span>gen
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>concurrent <span class="token keyword">import</span> run_on_executor
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">from</span> tornado<span class="token punctuation">.</span>options <span class="token keyword">import</span> define<span class="token punctuation">,</span> options
<span class="token keyword">import</span> rela_baike_server
<span class="token keyword">from</span> rela_baike_server <span class="token keyword">import</span> RelaBaikeRequest<span class="token punctuation">,</span> RelaBaikeResult<span class="token punctuation">,</span> RelaBaikeServer
<span class="token keyword">import</span> logging
<span class="token keyword">from</span> logging<span class="token punctuation">.</span>handlers <span class="token keyword">import</span> TimedRotatingFileHandler

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">import</span> pdb

g_log_prefix <span class="token operator">=</span> <span class="token string">'../log/rela_baike_tornado.'</span>

<span class="token keyword">def</span> <span class="token function">getLogger</span><span class="token punctuation">(</span>strPrefixBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    strPrefix <span class="token operator">=</span> <span class="token string">&quot;%s%d&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>strPrefixBase<span class="token punctuation">,</span> os<span class="token punctuation">.</span>getpid<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">&quot;RELA_BAIKE&quot;</span><span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>propagate <span class="token operator">=</span> <span class="token boolean">False</span>
    handler <span class="token operator">=</span> TimedRotatingFileHandler<span class="token punctuation">(</span>strPrefix<span class="token punctuation">,</span> <span class="token string">'H'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    handler<span class="token punctuation">.</span>suffix <span class="token operator">=</span> <span class="token string">&quot;%Y%m%d_%H%M%S.log&quot;</span>
    formatter <span class="token operator">=</span> logging<span class="token punctuation">.</span>Formatter<span class="token punctuation">(</span><span class="token string">'%(asctime)s - %(name)s - %(levelname)s - %(message)s'</span><span class="token punctuation">)</span>
    handler<span class="token punctuation">.</span>setFormatter<span class="token punctuation">(</span>formatter<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>addHandler<span class="token punctuation">(</span>handler<span class="token punctuation">)</span>
    logger<span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

    <span class="token keyword">return</span> logger

<span class="token keyword">def</span> <span class="token function">makeResponseBody</span><span class="token punctuation">(</span>retCode<span class="token punctuation">,</span> errReason<span class="token punctuation">,</span> dicSummary<span class="token punctuation">)</span><span class="token punctuation">:</span>
    dicRes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    dicRes<span class="token punctuation">[</span><span class="token string">'retCode'</span><span class="token punctuation">]</span> <span class="token operator">=</span> retCode
    <span class="token keyword">if</span> retCode <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">:</span>
        dicRes<span class="token punctuation">[</span><span class="token string">'error'</span><span class="token punctuation">]</span> <span class="token operator">=</span> errReason
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        dicRes<span class="token punctuation">[</span><span class="token string">'data'</span><span class="token punctuation">]</span> <span class="token operator">=</span> dicSummary
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>dicRes<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">RelaBaikeHandler</span><span class="token punctuation">(</span>tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>RequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>
    executor <span class="token operator">=</span> ThreadPoolExecutor<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">initialize</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> relaServer<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>__serverRelaBaike <span class="token operator">=</span> relaServer
        self<span class="token punctuation">.</span>__logger <span class="token operator">=</span> logger

    <span class="token decorator annotation punctuation">@tornado<span class="token punctuation">.</span>gen<span class="token punctuation">.</span>coroutine</span>
    <span class="token keyword">def</span> <span class="token function">get</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        lstSummary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        retCode <span class="token operator">=</span> <span class="token number">0</span>
        errReason <span class="token operator">=</span> <span class="token string">&quot;&quot;</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            utfQuery <span class="token operator">=</span> self<span class="token punctuation">.</span>get_argument<span class="token punctuation">(</span><span class="token string">'query'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            errorReason <span class="token operator">=</span> <span class="token string">'Query encoding not utf-8.'</span>
            strRes <span class="token operator">=</span> makeResponseBody<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> errorReason<span class="token punctuation">,</span> lstSummary<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>strRes<span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        <span class="token keyword">if</span> utfQuery <span class="token operator">==</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">:</span>
            strRes <span class="token operator">=</span> makeResponseBody<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> lstSummary<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>strRes<span class="token punctuation">)</span>
            <span class="token keyword">return</span>

        error<span class="token punctuation">,</span> errReason<span class="token punctuation">,</span> lstSummary <span class="token operator">=</span> <span class="token keyword">yield</span> self<span class="token punctuation">.</span>getRelaBaike<span class="token punctuation">(</span>utfQuery<span class="token punctuation">)</span>
        strRes <span class="token operator">=</span> makeResponseBody<span class="token punctuation">(</span>error<span class="token punctuation">,</span> errReason<span class="token punctuation">,</span> lstSummary<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>write<span class="token punctuation">(</span>strRes<span class="token punctuation">)</span>

        <span class="token keyword">def</span> <span class="token function">__logResponse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> utfQuery<span class="token punctuation">,</span> relaResult<span class="token punctuation">)</span><span class="token punctuation">:</span>
            succ <span class="token operator">=</span> relaResult<span class="token punctuation">.</span>isSuccess<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> succ<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>__logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;%s\tSucc\t%s&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>utfQuery<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> relaResult<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>__logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">&quot;%s\tError:%d&quot;</span> <span class="token operator">%</span> <span class="token punctuation">(</span>utfQuery<span class="token punctuation">,</span> relaResult<span class="token punctuation">.</span>getError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token decorator annotation punctuation">@run_on_executor</span>
        <span class="token keyword">def</span> <span class="token function">getRelaBaike</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> utfQuery<span class="token punctuation">)</span><span class="token punctuation">:</span>
            error <span class="token operator">=</span> <span class="token number">0</span>
            lstSummary <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            relaBaikeRequest <span class="token operator">=</span> RelaBaikeRequest<span class="token punctuation">(</span>content<span class="token operator">=</span>utfQuery<span class="token punctuation">)</span>
            relaBaikeResult <span class="token operator">=</span> self<span class="token punctuation">.</span>__serverRelaBaike<span class="token punctuation">.</span>getRelaBaike<span class="token punctuation">(</span>relaBaikeRequest<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>__logResponse<span class="token punctuation">(</span>utfQuery<span class="token punctuation">,</span> relaBaikeResult<span class="token punctuation">)</span>

            <span class="token keyword">if</span> relaBaikeResult<span class="token punctuation">.</span>isSuccess<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> item <span class="token keyword">in</span> relaBaikeResult<span class="token punctuation">:</span>
                    baikeid <span class="token operator">=</span> item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    dicSummary <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'summary format error'</span> <span class="token punctuation">,</span>lstSummary
                lstSummary<span class="token punctuation">.</span>append<span class="token punctuation">(</span>dicSummary<span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> relaBaikeResult<span class="token punctuation">.</span>getError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rela_baike_server<span class="token punctuation">.</span>g_dic_error<span class="token punctuation">.</span>get<span class="token punctuation">(</span>relaBaikeResult<span class="token punctuation">.</span>getError<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'other error'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span>lstSummary

            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'success'</span><span class="token punctuation">,</span>lstSummary

<span class="token keyword">def</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    port <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>sys<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    serverRelaBaike <span class="token operator">=</span> rela_baike_server<span class="token punctuation">.</span>getRelaBaikeServer<span class="token punctuation">(</span><span class="token punctuation">)</span>
    logger <span class="token operator">=</span> getLogger<span class="token punctuation">(</span>g_log_prefix<span class="token punctuation">)</span>
    app <span class="token operator">=</span> tornado<span class="token punctuation">.</span>web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span>handlers<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token string">r&quot;/rela_baike&quot;</span><span class="token punctuation">,</span> RelaBaikeHandler<span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>relaServer<span class="token operator">=</span>serverRelaBaike<span class="token punctuation">,</span> logger<span class="token operator">=</span>logger<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    http_server <span class="token operator">=</span> tornado<span class="token punctuation">.</span>httpserver<span class="token punctuation">.</span>HTTPServer<span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    http_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    tornado<span class="token punctuation">.</span>ioloop<span class="token punctuation">.</span>IOLoop<span class="token punctuation">.</span>instance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">&quot;__main__&quot;</span><span class="token punctuation">:</span>
    start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="_1"><a href="#_1" class="header-anchor">#</a> 1.</h2> <h4 id="参考链接-2"><a href="#参考链接-2" class="header-anchor">#</a> 参考链接：</h4> <p>https://</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/22/2022, 11:43:55 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/backend/webapp/tornado/" class="prev router-link-active">
        tornado
      </a></span> <span class="next"><a href="/backend/webapp/tornado/02_issues.html">
        二. issues
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.f9092013.js" defer></script><script src="/assets/js/2.b3dd7b33.js" defer></script><script src="/assets/js/14.b2278c23.js" defer></script>
  </body>
</html>
